{% extends "base.html" %}

{% block title %}Edit Journal Entry - Geometric Journal{% endblock %}

{% block head_extra %}
    <style>
        #edit-entry-map {
            height: 400px;
            width: 100%;
            border-radius: 0.375rem; 
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            margin-bottom: 1rem; 
        }
        .map-search-input {
             box-sizing: border-box;
             border: 1px solid transparent;
             width: 240px;
             height: 32px;
             padding: 0 12px;
             border-radius: 3px;
             box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
             font-size: 14px;
             outline: none;
             text-overflow: ellipses;
             position: absolute;
             left: 50%;
             transform: translateX(-50%);
             margin-top: 10px; 
             z-index: 5;
        }
        .form-container {
            padding-top: 4rem;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container mx-auto bg-white p-8 rounded-lg shadow-md w-full max-w-md form-container">
        <h1 class="text-2xl font-semibold text-center mb-6">Edit Journal Entry</h1>

        {% if error %}
            <p class="text-red-500 text-center mb-4">{{ error }}</p>
        {% endif %}

        <form action="{{ url_for('edit_entry', entry_id=entry._id) }}" method="post" class="space-y-4">
            <input type="hidden" name="entry_id" value="{{ entry._id }}">

            <input type="hidden" id="latitude" name="latitude" value="{{ entry.get('latitude', '') }}">
            <input type="hidden" id="longitude" name="longitude" value="{{ entry.get('longitude', '') }}">

             <input id="pac-input" class="map-search-input" type="text" placeholder="Search for a place">

            <div id="edit-entry-map"></div>

            <div>
                <label for="date" class="block text-sm font-medium text-gray-700">Date:</label>
                <input type="date" id="date" name="date" value="{{ entry.get('date_str', '') }}" required
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            <div>
                <label for="place_name" class="block text-sm font-medium text-gray-700">Place Name:</label>
                 <input type="text" id="place_name" name="place_name" value="{{ entry.get('place_name', '') }}" required
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            <div>
                <label for="place_address" class="block text-sm font-medium text-gray-700">Place Address:</label>
                <input type="text" id="place_address" name="place_address" value="{{ entry.get('place_address', '') }}" required
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            <div>
                <label for="companions" class="block text-sm font-medium text-gray-700">Companions (comma-separated):</label>
                <input type="text" id="companions" name="companions" value="{{ entry.get('companions_str', '') }}"
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            <div>
                <label for="rating" class="block text-sm font-medium text-gray-700">Rating (e.g., 1-5):</label>
                 <input type="number" id="rating" name="rating" step="0.1" min="0" max="5" value="{{ entry.get('rating_str', '') }}"
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
             <div>
                <label for="category" class="block text-sm font-medium text-gray-700">Category:</label>
                 <input type="text" id="category" name="category" value="{{ entry.get('category', '') }}"
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            <div>
                <label for="review" class="block text-sm font-medium text-gray-700">Review:</label>
                 <textarea id="review" name="review" rows="4" required
                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">{{ entry.get('review', '') }}</textarea>
            </div>

            <div>
                <button type="submit"
                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Update Entry
                </button>
            </div>
        </form>

        <p class="mt-6 text-center text-sm text-gray-600">
            <a href="{{ url_for('my_entries') }}" class="font-medium text-blue-600 hover:text-blue-500">Cancel</a>
        </p>
         <div class="mt-4 text-center">
             <form action="{{ url_for('delete_entry', entry_id=entry._id) }}" method="post" class="inline-block">
                <button type="submit"
                        onclick="return confirm('Are you sure you want to delete this entry?');"
                        class="text-sm text-red-600 hover:text-red-800 font-medium focus:outline-none">
                    Delete This Entry
                </button>
            </form>
         </div>
    </div>

    <script>
        const apiKey = "{{ api_key }}";

        let map;
        let marker;
        let autocomplete;
        const latitudeInput = document.getElementById('latitude');
        const longitudeInput = document.getElementById('longitude');
        const placeNameInput = document.getElementById('place_name');
        const placeAddressInput = document.getElementById('place_address');

        const existingLat = parseFloat(latitudeInput.value);
        const existingLng = parseFloat(longitudeInput.value);
        const hasExistingCoords = !isNaN(existingLat) && !isNaN(existingLng);

        async function initMap() {
            if (!apiKey || apiKey === 'None') {
                console.error("Google Maps API key is not configured.");
                const mapDiv = document.getElementById('edit-entry-map');
                if (mapDiv) {
                    mapDiv.innerHTML = '<div class="flex items-center justify-center h-full text-red-600 font-semibold">Google Maps API key is missing or invalid. Please check configuration.</div>';
                    mapDiv.classList.add('bg-red-100');
                }
                return;
            }

            const { Map } = await google.maps.importLibrary("maps");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            const { Autocomplete } = await google.maps.importLibrary("places");
            const { Geocoder } = await google.maps.importLibrary("geocoding");
            const geocoder = new Geocoder();

            let initialCenter = { lat: 39.8283, lng: -98.5795 }; // Default center (e.g., center of US)
            let initialZoom = 4; 

            if (hasExistingCoords) {
                 initialCenter = { lat: existingLat, lng: existingLng };
                 initialZoom = 12; 
            }


            map = new Map(document.getElementById("edit-entry-map"), {
                center: initialCenter,
                zoom: initialZoom,
                mapId: "YOUR_MAP_ID", 
            });

            if (hasExistingCoords) {
                 marker = new AdvancedMarkerElement({
                     map: map,
                     position: initialCenter,
                     title: placeNameInput.value || 'Current Location',
                 });
                  const infoWindow = new google.maps.InfoWindow({
                    content: `<h3>${placeNameInput.value || 'Current Location'}</h3><p>${placeAddressInput.value || ''}</p>`,
                });
                 infoWindow.open(map, marker);
            }


            const input = document.getElementById("pac-input");
            autocomplete = new Autocomplete(input, {
                fields: ["address_components", "geometry", "icon", "name", "formatted_address"],
                types: ["geocode", "establishment"],
            });

            map.addListener("bounds_changed", () => {
                autocomplete.setBounds(map.getBounds());
            });

            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();

                if (!place.geometry || !place.geometry.location) {
                    console.error("Autocomplete returned place with no geometry.");
                    return;
                }

                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);
                }

                if (marker) {
                     marker.setMap(null);
                }

                marker = new AdvancedMarkerElement({
                    map: map,
                    position: place.geometry.location,
                    title: place.name,
                });

                latitudeInput.value = place.geometry.location.lat();
                longitudeInput.value = place.geometry.location.lng();

                placeNameInput.value = place.name || '';
                placeAddressInput.value = place.formatted_address || '';

                 const infoWindow = new google.maps.InfoWindow({
                    content: `<h3>${place.name || 'Unnamed Place'}</h3><p>${place.formatted_address || 'No Address'}</p>`,
                });
                 infoWindow.open(map, marker);

            });

            map.addListener("click", (event) => {
                const clickedLocation = event.latLng;

                if (marker) {
                     marker.setMap(null);
                }

                 marker = new AdvancedMarkerElement({
                    map: map,
                    position: clickedLocation,
                    title: "Selected Location",
                 });

                 map.setCenter(clickedLocation);
                 map.setZoom(map.getZoom() < 12 ? 12 : map.getZoom());

                 latitudeInput.value = clickedLocation.lat();
                 longitudeInput.value = clickedLocation.lng();

                 geocoder.geocode({ location: clickedLocation })
                    .then((response) => {
                        if (response.results[0]) {
                            const place = response.results[0];
                            placeAddressInput.value = place.formatted_address || '';
                             console.log("Reverse geocoded address:", place.formatted_address);

                             const infoWindow = new google.maps.InfoWindow({
                                content: `<h3>Selected Location</h3><p>${place.formatted_address || 'No Address Found'}</p>`,
                            });
                            infoWindow.open(map, marker);

                        } else {
                            console.log("No results found for reverse geocoding.");
                            placeAddressInput.value = '';
                             const infoWindow = new google.maps.InfoWindow({
                                content: `<h3>Selected Location</h3><p>No address found</p>`,
                            });
                            infoWindow.open(map, marker);
                        }
                    })
                    .catch((e) => {
                        console.error("Geocoder failed due to: " + e);
                         placeAddressInput.value = ''; 
                          const infoWindow = new google.maps.InfoWindow({
                                content: `<h3>Selected Location</h3><p>Error fetching address</p>`,
                            });
                            infoWindow.open(map, marker);
                    });
            });
        }

        function loadGoogleMapsScript() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&libraries=geometry,marker,places,geocoding&loading=async`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }

        window.onload = loadGoogleMapsScript;
    </script>
{% endblock %}
